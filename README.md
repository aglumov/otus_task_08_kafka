# Задание

Реализация очереди для сборщика логов для OpenSearch:
- развернуть кафку на 1 ноде
- создать 2 топика по 2 партиции и 2 реплики (nginx и wordpress)
- на каждой ноде поставить на выбор filebeat/fluentd/vector
- собирать этим утилитами логи nginx и wordpress
- отправлять в 2 разных топика nginx и wordpress
- развернуть ELK на одной ноде
- настроить логстэш для забора данных с кафки и сохранение в 2 индекса
- настроить индекс паттерны в кибане
Задание повышенной сложности* кафку и ELK развернуть в кластере


# Подготовка к запуску

Публичный ключ должен находиться по пути: ```~/.ssh/id_rsa.pub```

В системе должны быть установлены ansible и terraform. Тестировалось на версиях:
* ansible [core 2.13.8]
  * community.mysql 3.6.0
* terraform v1.5.5

# Настройка и запуск

* склонировать репозиторий;
* настроить подключение к облаку яндекс. Для этого перейти в каталог ```terraform``` создать файл ```yc.auto.tfvars``` с содержимым (подставить свой токен, id облака и каталога):

```
yc_token     = токен
yc_cloud_id  = id облака
yc_folder_id = id каталога
```

* инициализировать терраформ: ```terraform init```
* запустить создание инфраструктуры: ```terraform apply```
* после создания инфраструктуры дождаться загрузки ВМ
* перейти в каталог ```ansible``` и запустить плейбук: ```ansible-playbook setup.yaml```:
  * при необходимости переопределить пароли: ```-e "admin_password=admin kibanaserver_password=kibana logstash_password=logstash"```
* при успешном выполнении плейбука в выводе terraform взять ip-адрес из ```nginx_public_ip_address``` и подключиться по http:
  * в основном location будет доступно приложение WordPress
  * в location ```os``` будет доступен Dashboards (можно переопределить в переменной ```os_prefix```)

# Пояснения

Процесс развертывания окружения при помощи terraform и установка ПО при помощи ansible записал на видео, т.к. требуется очень много скриншотов, чтобы всё зафиксировать.

Видео доступно по ссылке: https://disk.yandex.ru/i/C5e64VpzR03lww

* инфраструктура проекта взята из задания 7 (настройка сбора логов в elasticsearch):
  * ```lb0```: балансировщик (nginx);
  * ```app0-1```: сервера веб-приложения (Wordpress);
  * ```db0```: база данных веб-приложения (mariadb);
* роли для установки OpenSearch скопированы из [репозитория](https://github.com/opensearch-project/ansible-playbook) в каталог ```roles```;
* OpenSearch, Dashboards и Logstash устанавливаются на сервере ```os0```;
* Zookeeper и Kafka разворачиваются в кластере на серверах ```kafka0-2```;
* Filebeat устанавливается на серверах: ```lb0```, ```app0-1```.
